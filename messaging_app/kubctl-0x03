#!/bin/bash

# Step 1: Apply the updated deployment
echo "Applying updated deployment (v2.0)..."
kubectl apply -f messaging_app/blue_deployment.yaml

# Step 2: Monitor rollout status
echo "Monitoring rollout status..."
kubectl rollout status deployment/messaging-blue

# Step 3: Continuous availability check during rollout
echo "Testing app availability..."
for i in {1..20}
do
  curl -s http://localhost:8000/ > /dev/null
  if [ $? -eq 0 ]; then
    echo "[$i] ✅ App is reachable"
  else
    echo "[$i] ❌ App might be down"
  fi
  sleep 2
done

# Step 4: Check pods after rollout
echo "Verifying updated pods..."
kubectl get pods -l app=messaging -o wide
